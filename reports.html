<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Doc | Analytics Dashboard</title>
    
    <!-- Unique K-Doc Favicon (Blue square with white 'K') -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill=' %232563eb'/%3E%3Ctext x='50%25' y='50%25' domaint-anchor='middle' dy='.35em' font-family='Arial, sans-serif' font-size='60' font-weight='900' fill='white' text-anchor='middle'%3EK%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; transition: background 0.3s ease; }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; }
            .report-card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; margin: 0 !important; width: 100% !important; }
            .observation-grid { grid-template-columns: 1fr !important; gap: 2rem !important; }
            .page-break { page-break-after: always; }
            .break-inside-avoid { break-inside: avoid; }
        }

        .observation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .portfolio-view .observation-grid {
            grid-template-columns: 1fr;
            max-width: 800px;
            margin: 0 auto;
        }

        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.25em;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .tab-btn.active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                    </svg>
                </div>
                <span class="font-black tracking-tight text-xl italic uppercase">K-Doc Analytics</span>
            </div>
            
            <div class="flex gap-2">
                <button id="viewGrid" onclick="setView('grid')" class="tab-btn active px-4 py-2 rounded-lg text-sm font-bold transition-all">Analytics Grid</button>
                <button id="viewPortfolio" onclick="setView('portfolio')" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold transition-all">Parent Portfolio</button>
            </div>
        </div>
    </nav>

    <!-- Filters -->
    <div class="max-w-7xl mx-auto p-6 no-print">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Teacher</label>
                <select id="teacherFilter" onchange="updateStudentFilter()" class="custom-select w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                    <option value="all">All Teachers</option>
                </select>
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">Student</label>
                <select id="studentFilter" onchange="renderView()" class="custom-select w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                    <option value="all">All Students</option>
                </select>
            </div>
            <div class="flex items-end gap-2">
                <button onclick="fetchData()" class="flex-1 bg-blue-50 text-blue-600 font-bold py-3 rounded-xl hover:bg-blue-100 transition-all flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" id="refreshIcon" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Sync Data
                </button>
                <button onclick="window.print()" class="bg-slate-800 text-white p-3 rounded-xl hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <main id="dashboardContent" class="max-w-7xl mx-auto px-6 pb-20"></main>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycby_-5K5U40NT0lrY7H5u6otPKwEO8-a9ZdUtxuW1CPVcA6f7w0Xlv-anhUvMIKXynLHKw/exec";
        
        let rawData = [];
        let currentView = 'grid'; // 'grid' or 'portfolio'
        const teacherFilter = document.getElementById('teacherFilter');
        const studentFilter = document.getElementById('studentFilter');
        const dashboard = document.getElementById('dashboardContent');

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(view === 'grid' ? 'viewGrid' : 'viewPortfolio').classList.add('active');
            
            if (view === 'portfolio' && studentFilter.value === 'all') {
                alert("Please select a specific student to generate a Parent Portfolio.");
                setView('grid');
                return;
            }
            
            renderView();
        }

        function parseStudents(inputString) {
            if (!inputString) return [];
            if (inputString.includes('|')) return inputString.split('|').map(s => s.trim()).filter(Boolean);
            const pattern = /[^,]+,\s*[^,]+/g;
            const matches = inputString.match(pattern);
            return (matches && matches.length > 0) ? matches.map(s => s.trim()).filter(Boolean) : [inputString.trim()];
        }

        async function fetchData() {
            dashboard.innerHTML = `<div class="text-center py-20"><div class="loading-shimmer h-64 rounded-2xl w-full"></div></div>`;
            try {
                const response = await fetch(`${scriptURL}?mode=getReports`);
                rawData = await response.json();
                populateFilters();
                renderView();
            } catch (err) {
                console.error("Fetch error:", err);
                dashboard.innerHTML = `<div class="bg-red-50 p-8 rounded-2xl text-center text-red-800 font-bold">Sync Failed. Check ScriptURL.</div>`;
            }
        }

        function populateFilters() {
            const teachers = [...new Set(rawData.map(item => item.teacher || item.Teacher))].filter(Boolean).sort();
            teacherFilter.innerHTML = '<option value="all">All Teachers</option>' + teachers.map(t => `<option value="${t}">${t}</option>`).join('');
            updateStudentFilter();
        }

        function updateStudentFilter() {
            const selectedTeacher = teacherFilter.value;
            const filteredData = selectedTeacher === 'all' ? rawData : rawData.filter(item => (item.teacher || item.Teacher) === selectedTeacher);
            const studentsSet = new Set();
            filteredData.forEach(item => {
                parseStudents(item.students || item.Students || "").forEach(name => studentsSet.add(name));
            });
            const sortedStudents = [...studentsSet].sort();
            studentFilter.innerHTML = '<option value="all">All Students</option>' + sortedStudents.map(s => `<option value="${s}">${s}</option>`).join('');
            renderView();
        }

        function formatImageUrl(url) {
            if (!url || url === "No Image" || url === "undefined") return null;
            if (url.includes('drive.google.com')) {
                const match = url.match(/[-\w]{25,}/);
                return match ? `https://lh3.googleusercontent.com/u/0/d/${match[0]}` : url;
            }
            return url;
        }

        function renderView() {
            if (currentView === 'portfolio') renderPortfolio();
            else renderGrid();
        }

        function renderGrid() {
            document.body.classList.remove('portfolio-view');
            const teacher = teacherFilter.value;
            const student = studentFilter.value;
            
            const filtered = rawData.filter(item => {
                const teacherMatch = teacher === 'all' || (item.teacher || item.Teacher) === teacher;
                const studentList = parseStudents(item.students || item.Students || "");
                return teacherMatch && (student === 'all' || studentList.includes(student));
            }).reverse();

            if (filtered.length === 0) {
                dashboard.innerHTML = `<div class="text-center py-20 text-slate-400">No records found.</div>`;
                return;
            }

            let html = `<div class="observation-grid">`;
            filtered.forEach(obs => {
                const img = formatImageUrl(obs.imageurl || obs.imagedata || obs.imageUrl || obs['image url']);
                const date = obs.timestamp ? new Date(obs.timestamp).toLocaleDateString() : '---';
                
                const expectationText = obs.expectations || obs.Expectations || '---';
                const notesText = obs.comment || obs.Comment || obs.description || obs.Description || obs.notes || 'No notes.';

                html += `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col h-full break-inside-avoid">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-[10px] font-black bg-blue-600 text-white px-2 py-1 rounded uppercase tracking-tighter">${obs.frame || 'Doc'}</span>
                            <span class="text-[10px] font-bold text-slate-400">${date}</span>
                        </div>
                        <div class="flex-grow">
                             <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Expectation</p>
                             <h4 class="font-bold text-slate-800 leading-tight mb-4">${expectationText}</h4>
                             <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Notes</p>
                             <p class="text-slate-600 text-sm italic leading-relaxed">"${notesText}"</p>
                        </div>
                        ${img ? `<img src="${img}" class="mt-4 h-48 w-full object-cover rounded-xl shadow-inner">` : ''}
                    </div>
                `;
            });
            html += `</div>`;
            dashboard.innerHTML = html;
        }

        function renderPortfolio() {
            document.body.classList.add('portfolio-view');
            const student = studentFilter.value;
            const teacher = teacherFilter.value;
            
            const filtered = rawData.filter(item => {
                const studentList = parseStudents(item.students || item.Students || "");
                return studentList.includes(student);
            }).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

            let html = `
                <div class="max-w-4xl mx-auto bg-white p-12 rounded-3xl shadow-xl border border-slate-100 report-card">
                    <div class="flex justify-between items-end border-b-4 border-blue-600 pb-8 mb-8">
                        <div>
                            <h1 class="text-5xl font-black text-slate-900 tracking-tighter">${student}</h1>
                            <p class="text-blue-600 font-bold uppercase tracking-widest mt-2">Individual Documentation Portfolio</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-black text-slate-400 uppercase">Academic Year</p>
                            <p class="text-lg font-bold text-slate-800 tracking-tight">2025 - 2026</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-8 mb-12">
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Total Entries</p>
                            <p class="text-3xl font-black text-slate-800">${filtered.length}</p>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Teacher</p>
                            <p class="text-xl font-bold text-slate-700">${teacher === 'all' ? 'All Classes' : teacher}</p>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Generated</p>
                            <p class="text-xl font-bold text-slate-700">${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>

                    <div class="observation-grid">
            `;

            filtered.forEach(obs => {
                const img = formatImageUrl(obs.imageurl || obs.imagedata || obs.imageUrl || obs['image url']);
                const date = obs.timestamp ? new Date(obs.timestamp).toLocaleDateString(undefined, {month:'long', day:'numeric', year:'numeric'}) : '---';
                
                const expectationText = obs.expectations || obs.Expectations || 'Learning Moment';
                const notesText = obs.comment || obs.Comment || obs.description || obs.Description || obs.notes || 'Observation recorded.';

                html += `
                    <div class="border-l-4 border-slate-200 pl-8 py-4 mb-8 break-inside-avoid">
                        <div class="flex items-center gap-4 mb-4">
                            <span class="text-sm font-black text-blue-600 uppercase tracking-widest">${date}</span>
                            <span class="h-px flex-grow bg-slate-100"></span>
                            <span class="px-3 py-1 bg-slate-100 text-[10px] font-black rounded-full uppercase text-slate-500">${obs.frame || 'General'}</span>
                        </div>
                        
                        <h3 class="text-2xl font-extrabold text-slate-800 mb-2 leading-tight">${expectationText}</h3>
                        <p class="text-lg text-slate-600 leading-relaxed mb-6 italic">"${notesText}"</p>
                        
                        ${img ? `<div class="rounded-3xl overflow-hidden shadow-lg border border-slate-50 mb-4"><img src="${img}" class="w-full h-auto max-h-[500px] object-cover"></div>` : ''}
                    </div>
                `;
            });

            html += `
                    </div>
                    <div class="mt-20 pt-10 border-t border-slate-100 text-center">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Confidential Educational Documentation â€¢ Generated via K-Doc System</p>
                    </div>
                </div>
            `;
            dashboard.innerHTML = html;
        }

        window.onload = fetchData;
    </script>
</body>
</html>
